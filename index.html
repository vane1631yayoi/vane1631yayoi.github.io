<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¡Œç¨‹è¨ˆç•« - ç¾ä»£å¡ç‰‡è¦–è¦ºç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS ç¢ºä¿éŸ¿æ‡‰å¼è¨­è¨ˆå’Œæ¸…æ™°æ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¼‰å…¥ Inter å­—é«”ï¼Œç¢ºä¿æ¸…æ™°åº¦ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* æ·ºç°è‰²èƒŒæ™¯ */
            color: #1e293b; 
        }
        /* ä¸»é«”è‰²èª¿ï¼šæ·±è—/ç´« */
        .primary-bg {
            background-color: #4f46e5; /* é›è—è‰² */
        }
        .primary-text {
            color: #4f46e5;
        }
        /* å°è¦½æŒ‰éˆ•æ¨£å¼ */
        .tab-button {
            transition: all 0.2s;
            min-width: 130px;
            height: 80px;
            font-size: 1.125rem; /* text-lg */
        }
        .tab-active {
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.4);
            border: 2px solid white;
            transform: scale(1.05);
            font-weight: bold;
        }
        /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ */
        .itinerary-card {
            border-left: 5px solid #4f46e5; 
            transition: all 0.2s;
        }
        /* å¯é»æ“Šåœ°åœ–çš„å…ƒç´ æ¨£å¼ */
        .map-clickable {
            cursor: pointer;
            text-decoration: underline;
            color: #1e40af; /* æ·±è—è‰² */
            font-weight: bold;
        }
        /* é£¯åº—è³‡è¨Šå¡ç‰‡ */
        .hotel-card {
            background-color: #eef2ff; /* æ·ºé›è—è‰² */
            border: 1px solid #c7d2fe;
        }
        /* æ¨¡æ…‹è¦–çª—æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* åŠé€æ˜é»‘è‰²é®ç½© */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            visibility: hidden; /* é è¨­éš±è— */
            opacity: 0; /* é è¨­å®Œå…¨é€æ˜ */
            transition: visibility 0.3s, opacity 0.3s;
        }
        .modal-overlay.show {
            visibility: visible;
            opacity: 1;
        }    
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-2xl */
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto; /* å…§å®¹éå¤šæ™‚å¯æ»¾å‹• */
            position: relative;
            transform: translateY(-50px); /* åˆå§‹ä½ç½®ç¨å¾®å‘ä¸Š */
            transition: transform 0.3s ease-out;
        }      
        .modal-overlay.show .modal-content {
            transform: translateY(0); /* é¡¯ç¤ºæ™‚å›åˆ°æ­£å¸¸ä½ç½® */
        }
        /* é—œé–‰æŒ‰éˆ• */
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            color: #6b7280; /* text-gray-500 */
            transition: color 0.2s;
        }
        .modal-close-button:hover {
            color: #1f2937; /* text-gray-800 */
        }
        /* è¡Œææ¸…å–®é …ç›®æ¨£å¼ */
        .luggage-item-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
        }
        .luggage-item-checkbox {
            margin-right: 0.75rem;
            width: 1.25rem; /* h-5 w-5 */
            height: 1.25rem;
            accent-color: #4f46e5; /* primary-blue */
        }
        .luggage-item-text {
            flex-grow: 1;
            font-size: 1rem;
            color: #374151; /* text-gray-700 */
        }
        .luggage-item-text.checked {
            text-decoration: line-through;
            color: #9ca3af; /* text-gray-400 */
        }
        /* æ–°å¢/åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .btn-action {
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: background-color 0.2s;
        }
        .btn-delete {
            background-color: #f87171; /* red-400 */
            color: white;
        }
        .btn-delete:hover {
            background-color: #ef4444; /* red-500 */
        }
        .person-card {
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .person-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
            
    </style>
    <script>
        // è¨­å®š Tailwind é…ç½®ä»¥ä½¿ç”¨è‡ªå®šç¾©é¡è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4f46e5',
                        'secondary-card': '#eef2ff',
                    },
                }
            }
        }
    </script>
</head>
<body>
    
    <!-- JS å‡½å¼ï¼šé–‹å•Ÿ Google Map -->
    <script>
        /**
         * é–‹å•Ÿ Google Map æœå°‹æŒ‡å®šåœ°é»
         * @param {string} query - åœ°åœ–æœå°‹çš„é—œéµå­—
         */
        window.openGoogleMap = function(query) {
            if (query) {
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }
        };
    </script>
    
    <!-- å¼•å…¥ Firebase/Firestore æ¨¡çµ„ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Firestore æœå‹™å…¨åŸŸè®Šæ•¸
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isListenerAttached = false; // <-- æ–°å¢ï¼šé˜²æ­¢é‡è¤‡ç›£è½

        // æª¢æŸ¥ä¸¦åˆå§‹åŒ– Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ç¢ºä¿è¨­å®šæ—¥èªŒç´šåˆ¥ç‚º Debug
        setLogLevel('Debug');

        async function setupFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Data persistence will not work.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // è™•ç†èªè­‰
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        // åŒ¿åç™»å…¥ä½œç‚ºå¾Œå‚™
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        console.log("Signed in anonymously. User ID:", userId);
                    }
                    isAuthReady = true;
                    
                    // èªè­‰å®Œæˆå¾Œï¼Œè¨­å®š Firestore ç›£è½
                    window.loadChecklists(); 
                });

                // ä½¿ç”¨ custom token ç™»å…¥ (Canvas ç’°å¢ƒå°ˆç”¨)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // è‹¥ç„¡ tokenï¼Œå‰‡ä½¿ç”¨ onAuthStateChanged è™•ç†åŒ¿åç™»å…¥
                }

            } catch (error) {
                console.error("Firebase setup failed:", error);
                // å¦‚æœåˆå§‹åŒ–å¤±æ•—ï¼Œè‡³å°‘è®“ UI çŸ¥é“ä¸¦é¡¯ç¤ºéŒ¯èª¤
                window.renderErrorState("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚");
            }
        }
        
        // å°‡ Firestore å‡½å¼æš´éœ²çµ¦å…¨åŸŸç’°å¢ƒï¼Œè®“ä¸»è…³æœ¬å¯ä»¥ä½¿ç”¨
        window.db = () => db;
        window.getLuggageDocRef = () => {
             // å„²å­˜æ–¼ç§äººç©ºé–“ï¼š/artifacts/{appId}/users/{userId}/luggage_checklists/data/main
            if (!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/luggage_checklists`, 'main');
        };
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.isAuthReady = () => isAuthReady;
        window.auth = () => auth;

        setupFirebase();
    </script>


    <!-- ä¸» Header å€åŸŸ (æ¨¡æ“¬åœ–ç‰‡é ‚éƒ¨) -->
    <header class="primary-bg p-6 pb-20 shadow-2xl relative">
        <div class="max-w-4xl mx-auto">
            <div>
                <h1 class="text-3xl font-extrabold text-white">
                    âœˆï¸ åå¤å±‹ä¹‹æ—…
                </h1>
                <p class="text-lg text-indigo-200 mt-1">
                    3æœˆ13æ—¥ - 3æœˆ19æ—¥
                </p>
            </div>
            <a href="#" onclick="window.openLuggageChecklist(true); return false;" 
                class="absolute top-6 right-6 md:right-10 text-white hover:text-indigo-200 transition-colors duration-200"
                title="è¡Œæç¢ºèªæ¸…å–®">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                </svg>
            </a>
        </div>
    </header>

    <!-- æ—¥æœŸåˆ‡æ› Tab å€ (å›ºå®šåœ¨é ‚éƒ¨ä¸‹æ–¹ï¼Œå¯å·¦å³æ»‘å‹•) -->
    <div class="sticky top-0 z-30 bg-primary-bg">
        <nav id="day-tabs" class="flex overflow-x-auto whitespace-nowrap p-2 -mt-12 max-w-4xl mx-auto">
            <!-- Tab æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </nav>
    </div>

    <main id="itinerary-container" class="max-w-4xl mx-auto p-4 md:p-8 -mt-12">
        <!-- è¡Œç¨‹å…§å®¹å°‡ç”± JavaScript æ¸²æŸ“ -->
    </main>

    <footer class="p-6 mt-8 bg-gray-700 text-white text-center">
        <p class="text-base">ç¥æ‚¨æ—…é€”å¹³å®‰æ„‰å¿«ï¼</p>
    </footer>
    
    <!-- æ–°å¢ï¼šè¡Œææ¸…å–®æ¨¡æ…‹è¦–çª— (å…§å®¹å°‡ç”± JS å‹•æ…‹åˆ‡æ›) -->
    <div id="luggage-checklist-modal" class="modal-overlay" onclick="if(event.target.id === 'luggage-checklist-modal') window.closeLuggageChecklist();">
        <div class="modal-content w-11/12 md:w-2/3 lg:w-1/2">
            <!-- é—œé–‰æŒ‰éˆ• -->
            <span class="modal-close-button" onclick="window.closeLuggageChecklist();">&times;</span>
            
            <!-- å…§å®¹å€ï¼šå‹•æ…‹åˆ‡æ›é¡¯ç¤ºäººååˆ—è¡¨æˆ–å€‹äººæ¸…å–® -->
            <div id="modal-content-area">
                
            </div>

            <!-- æ™‚é–“æˆ³è¨˜èˆ‡ç‹€æ…‹é¡¯ç¤º (å›ºå®šåœ¨åº•éƒ¨) -->
            <div id="modal-footer" class="mt-6 pt-4 border-t text-sm text-gray-500 hidden">
                <p>æœ€å¾Œæ›´æ–°ï¼š<span id="last-updated-time"></span></p>
                <p>ç‹€æ…‹æœƒè‡ªå‹•å„²å­˜åˆ° Firestoreã€‚</p>
            </div>
        </div>
    </div>            
                    
    

    <script>
        // ============== è¡Œç¨‹ç›¸é—œè³‡æ–™ (ç¶­æŒä¸è®Š) ================
        const HOTEL_NAME = "Fresa Inn (INN åå¤å±‹é§…æ«»é€šå£)";
        const HOTEL_ADDRESS = "4 Chome-4-15 Meieki, Nakamura Ward, Nagoya, Aichi 450-0002æ—¥æœ¬";
        const HOTEL_MAP_QUERY = "Fresa Inn åå¤å±‹é§…æ«»é€šå£";
        
        const travelItinerary = [
            // ... (è¡Œç¨‹è³‡æ–™ä¿æŒä¸è®Š)
            {
                day: "Day 1",
                date: "3/13 (äº”)",
                theme: "TPEå•Ÿç¨‹èˆ‡æŠµé”åå¤å±‹",
                weather: "æ™´æœ—, 18Â°C",
                events: [
                    { time: "15:15", activity: "æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆé›†åˆ", note: "è«‹ç¢ºèªæ‰‹æ©Ÿ/è­·ç…§/é›»å­æ©Ÿç¥¨", location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ ç¬¬äºŒèˆªå»ˆ" },
                    { time: "17:15", activity: "TPE èµ·é£›", note: "ç­æ©Ÿä»£è™Ÿ:CI150" },
                    { time: "19:00", activity: "æ™šé¤", note: "é£›æ©Ÿé¤" },
                    { time: "21:05", activity: "æŠµé”åå¤å±‹", note: "é ˜å–è¡Œæï¼Œæº–å‚™ VISIT JAPAN QR CODE", location: "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´" },
                    { time: "21:37", activity: "è½‰ä¹˜åéµ", note: "éœ€è¦è²·å°è™Ÿåº§", location: "åå¤å±‹è»Šç«™" },
                    { time: "22:57", activity: "å…¥ä½ " + HOTEL_NAME, note: "ä¸­å¤®å‰ªç¥¨å£å‡ºç«™èµ°4åˆ†é˜", location: HOTEL_MAP_QUERY }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 2",
                date: "3/14 (å…­)",
                theme: "æ–‡åŒ–èˆ‡æ­·å²æ¢ç´¢",
                weather: "å¤šé›², 15Â°C",
                events: [
                    { time: "8:00", activity: "æ—©é¤", note: "Komedaå®¢å¤šç¾å’–å•¡ OR ã—ã‚“ã±ã¡é£Ÿå ‚ æ—¥å¼çƒ¤é­šæ—©é¤"},
                    { time: "9:30", activity: "åå¤å±‹ç§‘å­¸é¤¨", note: "æå‰è²·å…­/æ—¥çš„å‘¨æœ«ç’°ä¿åˆ¸(å¯æ­åœ°éµ/å·´å£«)", location: "åå¤å±‹ç§‘å­¸é¤¨" },
                    { time: "12:00", activity: "åˆé¤", note: "é£›é¨¨ç‰›ç‡’è‚‰ åˆé–“å¥—é¤", location: "ç‡’è‚‰ é¦¬å–°ä¸€ä»£ åå¤å±‹EAST" },
                    { time: "13:30", activity: "ç†±ç”°ç¥å®®", note: "æ­ä¹˜ååŸç·šå‰å¾€ ç†±ç”°ç¥å®®è¥¿", location: "ç†±ç”°ç¥å®®" },
                    { time: "14:30", activity: "ç†±ç”°ç¥å®® å¯¶ç‰©é¤¨", note: "500æ—¥åœ“é–€ç¥¨", location: "ç†±ç”°ç¥å®® å¯¶ç‰©é¤¨" },
                    { time: "16:00", activity: "Aeonè³¼ç‰© æˆ– æ¦®ç”ºé€›è¡—", note: "Aeonæœ‰è¶…å¸‚/æ¦®æœ‰ç™¾è²¨" },
                    { time: "19:00", activity: "æ™šé¤", note: "å¾·å…µè¡›è¿´è½‰å£½å¸ OR ç¾ç™»åˆ©å£½å¸" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 3",
                date: "3/15 (æ—¥)",
                theme: "å‰åœåŠ›å…¬åœ’ä¹‹æ—…(æ”œå¸¶è­·ç…§)",
                weather: "æ™´æœ—, 16Â°C",
                events: [
                    { time: "7:00", activity: "æ—©é¤", note: "ä¾¿åˆ©å•†åº— OR å‰ä¸€å¤©å…ˆè²·" },
                    { time: "7:30", activity: "åå¤å±‹è»Šç«™ --> è—¤ä¸˜(æ±å±±ç·š) --> æ„›åœ°çƒç´€å¿µå…¬åœ’(LINIMO)", note: "ä½¿ç”¨å‘¨æœ«ç’°ä¿åˆ¸+SUICA", location: "åå¤å±‹è»Šç«™" },
                    { time: "9:00", activity: "å‰åœåŠ›å…¬åœ’ å¤§å€‰åº«", note: "é ˆå¸¶è­·ç…§é©—ç¥¨", location: "Ghibliâ€™s Grand Warehouse" },
                    { time: "12:00", activity: "åˆé¤", note: "åœ’å€å…§çš„MOS Burge", location: "ãƒ¢ã‚¹ãƒãƒ¼ã‚¬ãƒ¼ ã‚­ãƒƒãƒãƒ³ã‚«ãƒ¼KC3" },
                    { time: "12:30", activity: "é­”å¥³ä¹‹è°·", note: "é­”å¥³ä¹‹å®¶ (å®‰é›…èˆ‡é­”å¥³)/ éœçˆ¾çš„ç§»å‹•åŸå ¡/ æ­å¥‡è«¾ä¹‹å®¶ (å¤©ç©ºä¹‹åŸ)", location: "é­”å¥³ã®è°·" },
                    { time: "15:00", activity: "å‹•å‹•åŠ›ä¹‹æ£® (æ­å…¬è»Š)", note: "å°æœˆèˆ‡å°æ¢…ä¹‹å®¶" , location: "ã©ã‚“ã©ã“æ£®"},
                    { time: "15:30", activity: "é­”æ³•ä¹‹é‡Œ(æ­å…¬è»Š)", note: "æ™‚é–“ä¸å¤ å¯è·³é" , location: "ã‚‚ã®ã®ã‘ã®é‡Œ" },
                    { time: "16:20", activity: "é’æ˜¥ä¹‹ä¸˜" , note: "è²“å’ªäº‹å‹™æ‰€(è²“çš„å ±æ©)/ åœ°çƒå±‹(å¿ƒä¹‹è°·)" , location: "é’æ˜¥ã®ä¸˜" },
                    { time: "19:30", activity: "æ™šé¤ (è¿‘æ¸…æ°´ç«™)", note: "ä¸²éŠ€ åŠ(çƒ¤é›è‚‰ä¸²) OR ãªã¾ã‚‰ã‚€ãƒ¼ã¡ã‚‡(ç¾Šè‚‰ç‡’è‚‰)", location: "ãªã¾ã‚‰ã‚€ãƒ¼ã¡ã‚‡" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 4",
                date: "3/16 (ä¸€)",
                theme: "çŠ¬å±±åŸä¹‹æ—…",
                weather: "å¤šé›², 15Â°C",
                events: [
                    { time: "8:20", activity: "æ—©é¤ + åƒåŠ å…­ä¹‹å¸‚", note: "åˆ·SUICAæ­åéµç·šåˆ° æœ¬ç¬ å¯º(4è™Ÿæœˆå°)", location: "ç¬ å¯ºè¦³éŸ³ï¼ˆç¬ è¦†å¯ºï¼‰"  },
                    { time: "9:00", activity: "Workmanæ¡è²·é˜²æ°´è£å‚™", note: "é˜²æ°´é‹/ é˜²é¢¨é˜²æ°´å¤–å¥—", location: "ãƒ¯ãƒ¼ã‚¯ãƒãƒ³ åå¤å±‹ç¬ å¯ºåº—" },
                    { time: "11:00", activity: "åˆé¤ ", note: "harbs åˆé–“å¥—é¤(ä¸èƒ½è¨‚ä½)", location: "ãƒãƒ¼ãƒ–ã‚¹ æ „æœ¬åº—" },
                    { time: "12:30", activity: "è²·çŠ¬å±±åŸå¥—ç¥¨", note: "åéµå”®ç¥¨å£ï¼Œé †ä¾¿å»è²·è‰¾è¨±å¥¶æ²¹æ³¡èŠ™", location: "åå¤å±‹è»Šç«™" },
                    { time: "13:40", activity: "çŠ¬å±±åŸ", note: "æ­ç‰¹æ€¥åˆ°çŠ¬å±±éŠåœ’åœ°", location: "çŠ¬å±±åŸ" },
                    { time: "15:00", activity: "åŸä¸‹ç”ºé€›è¡—", note: "ä¸‰å…‰ç¨»è·ç¥ç¤¾ é«”é©—æ´—éŒ¢(100ç¾Š)" },
                    { time: "17:00", activity: "æ™šé¤", note: "è“¬ãœã‚“ é°»é­šæ–™, é †è·¯è²· å°¾å¼µçŠ¬å±±è“åŒ ", location:"è“¬ãœã‚“ é°»é­šæ–™ç†" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 5",
                date: "3/17 (äºŒ)",
                theme: "ä¸­å±±é“ - å¦»ç± å®¿èˆ‡é¦¬é¾å®¿",
                weather: "é™£é›¨, 12Â°C",
                events: [
                    { time: "7:30", activity: "æ—©é¤", note: "å‰ä¸€å¤©å…ˆé»é¤ï¼Œè»Šä¸Šåƒ", location: "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ åå¤å±‹ã‚²ãƒ¼ãƒˆã‚¦ã‚©ãƒ¼ã‚¯åº—" },
                    { time: "8:00", activity: "äº¤é€š (å‰å¾€é¦¬ç± )", note: "æ­ä¹˜JRä¿¡æ¿ƒ åˆ°ä¸­å·æ´¥è»Šç«™ -> è½‰æ­ Magomeå·´å£« åˆ° Magome " },
                    { time: "9:35", activity: "é¦¬ç± å®¿ æ•£æ­¥", note: "å¯ä»¥è²·ä¸­å±±é“è­‰æ˜", location: "é¦¬ç± å®¿" },
                    { time: "10:30", activity: "åˆé¤", note: "ãŠé£Ÿäº‹å‡¦ æ¨¹æ¢¨, ä¸é¤“å¯ä»¥ä¸åƒæˆ–é»äº”å¹³é¤…ç­‰å°æ±è¥¿", location: "ãŠé£Ÿäº‹å‡¦ æ¨¹æ¢¨" },
                    { time: "11:30", activity: "é¦¬ç± å®¿ èµ°åˆ° å¦»ç± å®¿", note: "6.5km" },
                    { time: "14:30", activity: "å¦»ç± å®¿ æ•£æ­¥", note: "å¯è“‹ç« ä¸­å±±é“è­‰æ˜", location: "GOOD DAY Cafe" },                    
                    { time: "15:20", activity: "äº¤é€š(å›åå¤å±‹è»Šç«™)", note: "æ­é«˜é€Ÿå·´å£« éœ€é ç´„" , location: "ã€’399-5302 é•·é‡çœŒæœ¨æ›½éƒ¡å—æœ¨æ›½ç”ºå¾å¦»"},
                    { time: "17:30", activity: "æ™šé¤", note: "çŸ¢å ´è±¬æ’ or æ³•å¼è±¬æ’ katuretu matumura or é›ç¿… ä¸–ç•Œçš„å±±åŒ ", location: "ã‚«ãƒ„ãƒ¬ãƒ„MATUMURA" },
                    { time: "æœ‰åŠ›æ°£çš„è©±", activity: "æ³¡æ¹¯", note: "Canal resort(åå¤å±‹é§›) or Urban Quar(æ¦®)æ³¡æ¹¯ï¼Œæœ‰ç„¡æ–™é€è¿å·´å£«!", location: "ã‚­ãƒ£ãƒŠãƒ«ãƒ»ãƒªã‚¾ãƒ¼ãƒˆ" }                  
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 6",
                date: "3/18 (ä¸‰)",
                theme: "å¸‚é›†+é€›è¡—æ—¥",
                weather: "æ™´æœ—, 17Â°C",
                events: [
                    { time: "7:50", activity: "æ—©é¤", note: "æˆ‘å…ˆææ—©å»æ’éšŠ", location: "å¤©ç„¶é…µæ¯ã®é£Ÿãƒ‘ãƒ³å°‚é–€åº— ã¤ã°ã‚ãƒ‘ãƒ³ï¼†Milk åé§…åº—" },
                    { time: "9:30", activity: "å¤§é ˆè§€éŸ³éª¨è‘£å¸‚é›† + å•†åœˆ", note: "é’æŸ³ç¸½æœ¬å®¶/ç¯‰åœ°éŠ€ç« é­š/è¦ºç‹å±±æ°´æœå¤§ç¦/osu bakery", location: "å¤§é ˆè¦³éŸ³" },
                    { time: "11:30", activity: "åˆé¤", note: "å¤§é ˆè§€éŸ³ suzuyaç‚¸è±¬æ’(è¦æ’éšŠ) OR é‡‘å±± ç‡’è‚‰äºŒéƒ(å¯é ç´„)", location: "ç„¼è‚‰&æ‰‹æ‰“ã¡å†·éºº äºŒéƒ KANAYAMA" },
                    { time: "ä¸‹åˆæ™‚æ®µ", activity: "è‡ªç”±æ´»å‹•/æ•´ç†è¡Œæ", note: "é ç•™å……è¶³æ™‚é–“æ•´ç†è¡Œæèˆ‡ä¼‘æ¯" },
                    { time: "17:00", activity: "æ™šé¤", note: "è‡ªè¡Œè™•ç†" }
                ],
                hotel: HOTEL_ADDRESS,
                hotelMapQuery: HOTEL_MAP_QUERY
            },
            {
                day: "Day 7",
                date: "3/19 (å››)",
                shortDate: "3/19",
                theme: "ğŸ‘‹ æ­¸ç¨‹æ—¥",
                weather: "æ™´æœ—, 19Â°C",
                events: [
                    { time: "8:00", activity: "Check out", note: "æª¢æŸ¥æ‰‹æ©ŸéŒ¢åŒ…è­·ç…§ & è¡Œæç§¤é‡" },
                    { time: "8:30", activity: "æ­ä¹˜åéµç‰¹æ€¥(éƒ¨åˆ†å°è™Ÿåº§)åå¤å±‹æ©Ÿ", note: "å¯åˆ·suicaåè‡ªç”±åº§" },
                    { time: "9:11", activity: "è¯èˆª CHECK IN ", location: "æŠµé”åå¤å±‹æ©Ÿå ´ ç¬¬ä¸€èˆªå»ˆ" },
                    { time: "9:30", activity: "æ©Ÿå ´æ¡è³¼", note: "ä»™è²è¦ä¹‹é‡Œ", location: "ä»™è²è¦ä¹‹é‡Œ" },
                    { time: "10:00", activity: "åˆé¤", note: "T1 4Fæœ‰å¾ˆå¤šé¸æ“‡", location:"åŠè—è£½éºµ" },
                    { time: "10:30", activity:"éå®‰æª¢", note: "å¾Œé¢æœ‰å…ç¨…è³¼ç‰©" },
                    { time: "11:25", activity: "ç™»æ©Ÿ", note: "12:05 èµ·é£›" },
                    { time: "14:40", activity: "TPE é™è½", note: "å¹³å®‰æŠµé”å°ç£", location: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´" }
                ],
                hotel: "æœ¬æ—¥ç‚ºè¿”ç¨‹æ—¥ï¼Œç„¡ä½å®¿å®‰æ’ã€‚ç¥æ‚¨æ—…é€”é †åˆ©ï¼",
                hotelMapQuery: null 
            }
        ];

        // ====================== è¡Œææ¸…å–®åŠŸèƒ½ (æ–°å¢/ä¿®æ”¹) ======================
        
        // é è¨­çš„è¡Œææ¸…å–®æ¨¡æ¿
        const LUGGAGE_CHECKLIST_TEMPLATE = {
            carryOn: [
                { id: crypto.randomUUID(), name: 'è­·ç…§', checked: false, type: 'carryOn' },
                { id: crypto.randomUUID(), name: 'æ‰‹æ©Ÿ', checked: false, type: 'carryOn' },
                { id: crypto.randomUUID(), name: 'å……é›»å™¨', checked: false, type: 'carryOn' },
                { id: crypto.randomUUID(), name: 'è¡Œå‹•é›»æº', checked: false, type: 'carryOn' },
                { id: crypto.randomUUID(), name: 'æ—¥å¹£ç¾é‡‘/ä¿¡ç”¨å¡', checked: false, type: 'carryOn' },           
                { id: crypto.randomUUID(), name: 'æ¼«éŠ/esim/sim', checked: false, type: 'carryOn' }
            ],
            checkedBaggage: [
                { id: crypto.randomUUID(), name: 'æ›¿æ›è¡£ç‰©', checked: false, type: 'checkedBaggage' },
                { id: crypto.randomUUID(), name: 'ä¿æš–è¡£ç‰©/å¸½å­/åœå·¾', checked: false, type: 'checkedBaggage' },
                { id: crypto.randomUUID(), name: 'å€‹äººè¡›ç”Ÿç”¨å“ (æ´—æ¼±ç”¨å“)', checked: false, type: 'checkedBaggage' },
                { id: crypto.randomUUID(), name: 'å£“ç¸®è¢‹/æ”¶ç´è¢‹', checked: false, type: 'checkedBaggage' }
            ]
        };

        // é è¨­çš„äº”å€‹äººååŠ ID
        const initialPeopleData = {

            'person_a': { name: 'å¼µé”è°', data: JSON.parse(JSON.stringify(LUGGAGE_CHECKLIST_TEMPLATE)) },
            'person_b': { name: 'é™³ç¾é›ª', data: JSON.parse(JSON.stringify(LUGGAGE_CHECKLIST_TEMPLATE)) },
            'person_c': { name: 'å¼µé›¯éˆ', data: JSON.parse(JSON.stringify(LUGGAGE_CHECKLIST_TEMPLATE)) },
            'person_d': { name: 'å¼µå®¹ç‘„', data: JSON.parse(JSON.stringify(LUGGAGE_CHECKLIST_TEMPLATE)) },
            'person_e': { name: 'å¼µç´˜å€«', data: JSON.parse(JSON.stringify(LUGGAGE_CHECKLIST_TEMPLATE)) }
        };

        let PEOPLE_LUGGAGE_STATE = initialPeopleData; // å„²å­˜æ‰€æœ‰äººçš„ç‹€æ…‹
        let currentPersonId = null; // ç•¶å‰é–‹å•Ÿæ¸…å–®çš„äºº ID
       
        /**
         * è™•ç† Firebase è³‡æ–™è®Šå‹•ï¼Œä¸¦æ›´æ–° UI
         * @param {Object} docSnapshot - Firestore Document Snapshot
         */
        window.handleLuggageSnapshot = function(docSnapshot) {
            const modalFooter = document.getElementById('modal-footer');
            const contentArea = document.getElementById('modal-content-area'); 

            if (docSnapshot.exists()) {
                const data = docSnapshot.data().checklists;
                // ä½¿ç”¨å¿«ç…§è³‡æ–™æ›´æ–°å…¨åŸŸç‹€æ…‹
                PEOPLE_LUGGAGE_STATE = data;
                document.getElementById('last-updated-time').textContent = new Date().toLocaleString();
                console.log("Luggage checklist loaded/updated from Firestore.");
            } else {
                // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯«å…¥é è¨­è³‡æ–™
                console.log("Luggage document not found. Setting up initial data.");
                window.saveChecklists(initialPeopleData);
                // æ³¨æ„ï¼šå¯«å…¥æœƒå†æ¬¡è§¸ç™¼ onSnapshotï¼Œå› æ­¤ä¸éœ€è¦åœ¨é€™è£¡æ‰‹å‹•æ¸²æŸ“ã€‚
            }
            
            modalFooter.classList.remove('hidden');

            // åªæœ‰åœ¨ Modal è¦–çª—é–‹å•Ÿæ™‚æ‰æ¸²æŸ“å…§å®¹ (æ¸…é™¤ Spinner)
            const modal = document.getElementById('luggage-checklist-modal');
            if (modal.classList.contains('show')) {
                // æ ¹æ“šç›®å‰è¦–åœ–ï¼Œæ±ºå®šé‡æ–°æ¸²æŸ“äººååˆ—è¡¨æˆ–å€‹äººæ¸…å–®
                if (currentPersonId) {
                    window.renderPersonalLuggageList(currentPersonId);
                } else {
                    window.renderPeopleList();
                }
            }
        };

        /**
         * å¾ Firestore è¼‰å…¥ä¸¦ç›£è½æ¸…å–®è³‡æ–™
         * é€™è£¡åƒ…è² è²¬è¨­å®šä¸€æ¬¡ç›£è½å™¨
         */
        window.loadChecklists = function() {
            if (isListenerAttached) {
                console.log("Firestore listener already attached.");
                return;
            }
            if (!window.isAuthReady()) {
                console.warn("Auth not ready yet, skipping loadChecklists.");
                return;
            }

            const docRef = window.getLuggageDocRef();
            if (docRef) {
                isListenerAttached = true; // <-- è¨­å®šæ——æ¨™ï¼Œè¡¨ç¤ºç›£è½å™¨å·²é™„è‘—
                // ä½¿ç”¨ onSnapshot ç›£è½å³æ™‚æ›´æ–°
                window.onSnapshot(docRef, window.handleLuggageSnapshot, (error) => {
                    console.error("Error listening to luggage snapshot:", error);
                    
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œæ¸…é™¤ Spinner
                    window.renderErrorState("è³‡æ–™åº«é€£ç·šå¤±æ•—æˆ–æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è¼‰å…¥æ¸…å–®ã€‚");
                });
            } else {
                console.error("Firestore Document Reference is not available.");
                // å¦‚æœç„¡æ³•å–å¾—æ–‡ä»¶å¼•ç”¨ï¼Œä¹Ÿæ‡‰é¡¯ç¤ºéŒ¯èª¤
                window.renderErrorState("Firebase æœå‹™æœªæº–å‚™å¥½ï¼Œè«‹é‡æ–°æ•´ç†ã€‚");
            }
        };

        /**
         * æ¸²æŸ“éŒ¯èª¤ç‹€æ…‹
         * @param {string} message - éŒ¯èª¤è¨Šæ¯
         */
        window.renderErrorState = function(message) {
            const contentArea = document.getElementById('modal-content-area');
            const modal = document.getElementById('luggage-checklist-modal');
            
            // åªæœ‰ç•¶ Modal æ­£åœ¨é¡¯ç¤ºæ™‚æ‰è¦†è“‹å…§å®¹
            if (modal.classList.contains('show')) {
                contentArea.innerHTML = `
                    <div class="text-center p-8 bg-red-50 border border-red-400 rounded-lg">
                        <p class="text-2xl text-red-600 mb-3">âŒ è¼‰å…¥å¤±æ•—</p>
                        <p class="text-gray-700">${message}</p>
                    </div>
                `;
            }
        }


        /**
         * å°‡ç•¶å‰æ¸…å–®ç‹€æ…‹å„²å­˜åˆ° Firestore
         * @param {Object} [dataToSave=PEOPLE_LUGGAGE_STATE] - è¦å„²å­˜çš„è³‡æ–™ç‰©ä»¶
         */
        window.saveChecklists = async function(dataToSave = PEOPLE_LUGGAGE_STATE) {
            const docRef = window.getLuggageDocRef();
            if (!docRef) {
                console.error("Cannot save: Firestore not initialized or user not logged in.");
                return;
            }

            try {
                // ä½¿ç”¨ setDoc å„²å­˜ï¼Œç¢ºä¿æ¯æ¬¡éƒ½å¸¶æœ‰æœ€æ–°çš„æ™‚é–“æˆ³
                await window.setDoc(docRef, { checklists: dataToSave, updated: new Date().toISOString() }, { merge: true });
                console.log("Luggage checklist saved to Firestore.");
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        };

        /**
         * é–‹å•Ÿ/é—œé–‰è¡Œææ¸…å–®æ¨¡æ…‹è¦–çª—ï¼Œä¸¦é¡¯ç¤ºäººååˆ—è¡¨
         * @param {boolean} show - true ç‚ºé–‹å•Ÿï¼Œfalse ç‚ºé—œé–‰
         */
        window.openLuggageChecklist = function(show) {
            const modal = document.getElementById('luggage-checklist-modal');
            const contentArea = document.getElementById('modal-content-area'); 
            
            if (show) {
                currentPersonId = null; // é‡ç½®åˆ°äººååˆ—è¡¨è¦–åœ–
                modal.classList.add('show');
                document.body.style.overflow = 'hidden'; 
                
                window.renderPeopleList();
                
            } else {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        };

        /**
         * é—œé–‰æ¨¡æ…‹è¦–çª—
         */
        window.closeLuggageChecklist = function() {
            window.openLuggageChecklist(false);
        }

        /**
         * æ¸²æŸ“äº”å€‹äººåçš„åˆ—è¡¨
         */
        window.renderPeopleList = function() {
            const contentArea = document.getElementById('modal-content-area');

            let html = `
                <h2 class="text-2xl font-bold primary-text mb-6">ğŸ“¦ é¸æ“‡æˆå“¡æ¸…å–®</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            `;

            for (const id in PEOPLE_LUGGAGE_STATE) {
                const person = PEOPLE_LUGGAGE_STATE[id];
                const data = person.data; // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ data å±¬æ€§
                
                const checkedCount = data.carryOn.filter(i => i.checked).length + 
                                     data.checkedBaggage.filter(i => i.checked).length;
                const totalCount = data.carryOn.length + data.checkedBaggage.length;
                const progressColor = checkedCount === totalCount && totalCount > 0 ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-primary-blue';
                
                html += `
                    <div class="person-card cursor-pointer flex flex-col justify-center items-center text-center ${progressColor}" 
                         onclick="window.renderPersonalLuggageList('${id}')">
                        <span class="text-4xl mb-2">ğŸ‘¤</span>
                        <p class="text-lg font-bold">${person.name}</p>
                        <p class="text-sm mt-1">é€²åº¦: ${checkedCount}/${totalCount}</p>
                    </div>
                `;
            }

            html += `</div>`;
            contentArea.innerHTML = html;
        };


        /**
         * æ¸²æŸ“ç‰¹å®šæˆå“¡çš„è¡Œææ¸…å–®
         * @param {string} personId - æˆå“¡çš„ ID
         */
        window.renderPersonalLuggageList = function(personId) {
            currentPersonId = personId;
            const person = PEOPLE_LUGGAGE_STATE[personId];
            if (!person) {
                console.error("Person not found:", personId);
                window.renderPeopleList();
                return;
            }

            const contentArea = document.getElementById('modal-content-area');
            let html = `
                <div class="flex items-center mb-6">
                    <button onclick="window.renderPeopleList()" class="text-primary-blue hover:text-indigo-700 mr-4 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800">${person.name} çš„è¡Œææ¸…å–® ğŸ’</h2>
                </div>

                <!-- æ‰‹æè¡Œæ -->
                <div class="mb-6 border-b pb-4">
                    <h3 class="text-xl font-semibold primary-text mb-2">æ‰‹æè¡Œæ (Carry-on)</h3>
                    <div id="carry-on-list" class="space-y-1">
                        ${person.data.carryOn.map(item => createLuggageItemHTML(item, personId)).join('')}
                    </div>
                    ${createAddItemFormHTML('carryOn', personId)}
                </div>

                <!-- æ‰˜é‹è¡Œæ -->
                <div>
                    <h3 class="text-xl font-semibold primary-text mb-2">æ‰˜é‹è¡Œæ (Checked Baggage)</h3>
                    <div id="checked-baggage-list" class="space-y-1">
                        ${person.data.checkedBaggage.map(item => createLuggageItemHTML(item, personId)).join('')}
                    </div>
                    ${createAddItemFormHTML('checkedBaggage', personId)}
                </div>
            `;
            
            contentArea.innerHTML = html;
        };

        /**
         * ç”Ÿæˆå–®å€‹æ¸…å–®é …ç›®çš„ HTML
         */
        function createLuggageItemHTML(item, personId) {
            return `
                <div id="item-${item.id}" class="luggage-item flex justify-between items-center bg-gray-50 hover:bg-gray-100 rounded-lg pr-2">
                    <label for="luggage-${item.id}" class="luggage-item-label flex-1 p-2">
                        <input type="checkbox" 
                               id="luggage-${item.id}" 
                               class="luggage-item-checkbox" 
                               ${item.checked ? 'checked' : ''} 
                               onchange="window.toggleLuggageItem('${personId}', '${item.type}', '${item.id}')">
                        <span class="luggage-item-text ${item.checked ? 'checked' : ''}">${item.name}</span>
                    </label>
                    <button class="btn-action btn-delete" 
                            onclick="window.deleteLuggageItem('${personId}', '${item.type}', '${item.id}')">
                        åˆªé™¤
                    </button>
                </div>
            `;
        }
        
        /**
         * ç”Ÿæˆæ–°å¢é …ç›®è¡¨å–®çš„ HTML
         */
        function createAddItemFormHTML(type, personId) {
            const inputId = `new-item-input-${personId}-${type}`;
            return `
                <div class="flex mt-4">
                    <input type="text" id="${inputId}" placeholder="è¼¸å…¥æ–°é …ç›®..." class="flex-1 border p-2 rounded-l-md focus:ring-primary-blue focus:border-primary-blue">
                    <button class="bg-primary-blue text-white p-2 rounded-r-md hover:bg-indigo-700 transition"
                            onclick="window.addLuggageItem('${personId}', '${type}', document.getElementById('${inputId}').value)">
                        æ–°å¢
                    </button>
                </div>
            `;
        }

        /**
         * åˆ‡æ›æ¸…å–®é …ç›®ç‹€æ…‹
         */
        window.toggleLuggageItem = function(personId, type, itemId) {
            const list = PEOPLE_LUGGAGE_STATE[personId].data[type];
            const item = list.find(i => i.id === itemId);
            if (item) {
                item.checked = !item.checked;
                window.saveChecklists();
                // é‡æ–°æ¸²æŸ“å€‹äººæ¸…å–®ä»¥æ›´æ–° UI
                window.renderPersonalLuggageList(personId);
            }
        };

        /**
         * æ–°å¢æ¸…å–®é …ç›®
         */
        window.addLuggageItem = function(personId, type, itemName) {
            const name = itemName.trim();
            if (name === "") return;

            const newItem = {
                id: crypto.randomUUID(),
                name: name,
                checked: false,
                type: type 
            };
            
            PEOPLE_LUGGAGE_STATE[personId].data[type].push(newItem);
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById(`new-item-input-${personId}-${type}`).value = '';
            
            window.saveChecklists();
            window.renderPersonalLuggageList(personId);
        };
        
        /**
         * åˆªé™¤æ¸…å–®é …ç›®
         */
        window.deleteLuggageItem = function(personId, type, itemId) {
            const personData = PEOPLE_LUGGAGE_STATE[personId].data;
            // éæ¿¾æ‰è¦åˆªé™¤çš„é …ç›®
            personData[type] = personData[type].filter(item => item.id !== itemId);
            
            window.saveChecklists();
            window.renderPersonalLuggageList(personId);
        };
        
        // ====================== é é¢ä¸»é‚è¼¯ (ç¶­æŒä¸è®Š) ======================

        const container = document.getElementById('itinerary-container');
        const tabsContainer = document.getElementById('day-tabs');

        /**
         * æ¸²æŸ“ç‰¹å®šæ—¥æœŸçš„è¡Œç¨‹
         * @param {number} dayIndex - è¡Œç¨‹åœ¨ travelItinerary é™£åˆ—ä¸­çš„ç´¢å¼• (0 = Day 1)
         */
        function renderItinerary(dayIndex) {
            const dayPlan = travelItinerary[dayIndex];
            
            // æ¸…ç©ºèˆŠå…§å®¹
            container.innerHTML = ''; 

            // 1. é ‚éƒ¨æ—¥æœŸ/å¤©æ°£å¡ç‰‡ (æ¨¡æ“¬åœ–ç‰‡é¢¨æ ¼)
            const dateWeatherCard = document.createElement('div');
            dateWeatherCard.className = 'bg-white p-6 rounded-xl shadow-lg flex justify-between items-center mb-6';
            dateWeatherCard.innerHTML = `
                <div>
                    <p class="text-3xl font-extrabold primary-text">${dayPlan.date}</p>
                    <p class="text-xl text-gray-700">${dayPlan.theme}</p>
                </div>
                <div class="text-right">
                    <p class="text-4xl text-yellow-500">â˜€ï¸</p>
                    <p class="text-2xl font-bold primary-text">${dayPlan.weather.split(',')[1] || '17Â°C'}</p>
                    <p class="text-sm text-gray-500">${dayPlan.weather.split(',')[0] || 'æ™´æœ—'}</p>
                </div>
            `;
            container.appendChild(dateWeatherCard);

            // 2. å‰µå»ºæ´»å‹•åˆ—è¡¨
            dayPlan.events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'itinerary-card bg-white p-4 rounded-xl shadow-md mb-4 flex space-x-4 items-start';
                
                // è™•ç†æ´»å‹•åç¨±ï¼šå¦‚æœæ˜¯æ™¯é»ï¼Œå‰‡å¯é»æ“Š
                let activityHTML;
                const activityIcon = event.activity.includes("äº¤é€š") ? 'ğŸš—' : 
                                    event.activity.includes("é¤") || event.activity.includes("äº«ç”¨æ—©é¤") ? 'ğŸ½ï¸' : 
                                    event.activity.includes("æ©Ÿå ´") || event.activity.includes("ç™»æ©Ÿ") ? 'âœˆï¸' : 
                                    event.activity.includes("è³¼ç‰©") || event.activity.includes("æ¡è³¼") ? 'ğŸ›ï¸' : 
                                    'ğŸ“';

                if (event.location) {
                    // ä½¿ç”¨ span å…ƒç´ æ¨¡æ“¬é€£çµï¼Œä¸¦ç¶å®šé»æ“Šäº‹ä»¶
                    activityHTML = `
                        <span class="text-lg map-clickable hover:opacity-80 transition-opacity leading-snug" 
                              onclick="openGoogleMap('${event.location.replace(/'/g, "\\'")}')">
                            ${event.activity}
                        </span>
                    `;
                } else {
                    activityHTML = `<p class="text-lg font-bold text-gray-800 leading-snug">${event.activity}</p>`;
                }

                eventCard.innerHTML = `
                    <!-- å·¦å´ï¼šæ™‚é–“èˆ‡åœ–æ¨™ -->
                    <div class="flex-shrink-0 text-center w-20">
                        <p class="text-lg font-bold text-gray-600">${event.time}</p>
                        <p class="text-2xl mt-1">${activityIcon}</p>
                    </div>
                    
                    <!-- å³å´ï¼šæ´»å‹•å…§å®¹èˆ‡å‚™è¨» -->
                    <div class="flex-1 min-w-0">
                        ${activityHTML}
                        <!-- å‚™è¨» -->
                        <p class="mt-1 text-base text-gray-500 font-medium leading-snug">â–¶ ${event.note}</p>
                    </div>
                `;
                container.appendChild(eventCard);
            });

            // 3. é¡¯ç¤ºé£¯åº—åœ°å€å¡ç‰‡
            const hotelCard = document.createElement('div');
            hotelCard.className = 'hotel-card mt-8 p-6 rounded-xl shadow-lg';
            
            if (dayIndex === travelItinerary.length - 1) { // è™•ç†æœ€å¾Œä¸€å¤©è¿”ç¨‹æ—¥
                hotelCard.innerHTML = `
                    <p class="text-xl font-bold primary-text">âœ… ç•¶æ—¥è¡Œç¨‹å‚™è¨»</p>
                    <p class="text-lg mt-2 text-gray-700">${dayPlan.hotel}</p>
                `;
            } else { // é¡¯ç¤ºä½å®¿åœ°å€ï¼Œä½¿å…¶å¯é»æ“Š
                hotelCard.innerHTML = `
                    <p class="text-xl font-bold primary-text">ğŸ  ç•¶æ™šå…¥ä½é£¯åº— (é»æ“Šåœ°åœ–)</p>
                    <p class="text-lg font-semibold mt-2 map-clickable hover:opacity-80 transition-opacity"
                       onclick="openGoogleMap('${dayPlan.hotelMapQuery.replace(/'/g, "\\'")}')">
                        ${HOTEL_NAME}
                    </p>
                    <p class="text-base mt-1 leading-relaxed text-gray-600">${dayPlan.hotel}</p>
                `;
            }
            container.appendChild(hotelCard);

            // å°‡è¦–çª—æ²å‹•åˆ°è¡Œç¨‹å…§å®¹é ‚éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        /**
         * è™•ç†é»æ“Šäº‹ä»¶ï¼šåˆ‡æ›é¸ä¸­çš„ Tab å’Œé¡¯ç¤ºå…§å®¹
         */
        function selectDay(dayIndex) {
            // 1. æ›´æ–°æŒ‰éˆ•çš„ Active ç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active', 'primary-bg');
                btn.classList.add('bg-white', 'text-gray-800');
            });
            // ç‚ºç•¶å‰é»æ“Šçš„æŒ‰éˆ•æ·»åŠ  active æ¨£å¼
            const currentBtn = document.getElementById(`day-tab-${dayIndex}`);
            if (currentBtn) {
                currentBtn.classList.remove('bg-white', 'text-gray-800');
                currentBtn.classList.add('tab-active', 'primary-bg', 'text-white');
                
                currentBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }

            // 2. æ¸²æŸ“å°æ‡‰çš„è¡Œç¨‹å…§å®¹
            renderItinerary(dayIndex);
        }

        /**
         * å‹•æ…‹ç”Ÿæˆé ‚éƒ¨çš„ Tab æŒ‰éˆ•ä¸¦ç¶å®šäº‹ä»¶
         */
        function setupTabs() {
            travelItinerary.forEach((dayPlan, index) => {
                const button = document.createElement('button');
                button.id = `day-tab-${index}`;
                // åˆå§‹æ¨£å¼
                button.className = 'tab-button bg-white text-gray-800 rounded-xl shadow-md p-3 mx-2 flex-shrink-0';
                button.innerHTML = `
                    <p class="text-sm text-gray-500">${dayPlan.date.split(' ')[0]}</p>
                    <p class="text-lg font-semibold">${dayPlan.day}</p>
                `;
                
                // é»æ“Šäº‹ä»¶ï¼šå‘¼å« selectDay å‡½å¼
                button.addEventListener('click', () => selectDay(index));
                
                tabsContainer.appendChild(button);
            });
            
            // é è¨­é¸ä¸­ä¸¦é¡¯ç¤º Day 1
            selectDay(0);
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œè¨­å®š
        window.onload = function(){
            setupTabs();
            // Firebase setup (å·²åœ¨ type="module" script å€å¡ŠåŸ·è¡Œ)
        };
                        

    </script>
</body>
</html>

